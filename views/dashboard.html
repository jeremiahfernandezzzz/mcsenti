<!-- This is a static file -->
<!-- served from your routes in server.js -->

<!-- You might want to try something fancier: -->
<!-- html/nunjucks docs: https://mozilla.github.io/nunjucks/ -->
<!-- pug: https://pugjs.org/ -->
<!-- haml: http://haml.info/ -->
<!-- hbs(handlebars): http://handlebarsjs.com/ -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <title>MC Senti</title>
    <meta name="description" content="A cool thing made with Glitch">
    <link id="favicon" rel="icon" href="https://glitch.com/edit/favicon-app.ico" type="image/x-icon">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- import the webpage's stylesheet -->
    <link rel="stylesheet" href="/style.css">
    
    <!-- import the webpage's client-side javascript file -->
    <script src="/client.js" defer></script>
  </head>
  
  <script>
    
    var global_response = {};
    
  window.fbAsyncInit = function() {
    FB.init({
      appId      : '528140651036828',
      cookie     : true,
      xfbml      : true,
      version    : 'v3.2'
    });
      
    FB.AppEvents.logPageView();   
    
    FB.getLoginStatus(function(response){
      if (response.status === "connected"){
        FB.api('/me', 'GET', {fields: 'first_name,last_name,name,id,picture.width(50).height(50)'}, function(response) {
          document.getElementById('user_photo').src = response.picture.data.url;
          document.getElementById('user_name').innerHTML = response.name;
          document.getElementById("head").innerHTML = "Welcome to<br/>MC Senti";
        });
        FB.api('/326043571334336/feed?fields=id,message,name,comments,created_time', {
            'access_token': 'EAAHgV1PlgJwBAI45uaDMlZAmZBfNzUQIIVWXkQb8m5K2Hfa2umIpVifKQZCZCRHkcaHumZB0431dvL2VyM2HrgaZCfQczucOCh5lQ1uwMPZBp1VLErrIVfUYi0GNtfdErT6ZBs4m4W4ZC4oopr99ETyfd9KRfIsFiEJsVjqDlicdufsN95WuoEdKGvgrUkZAVfsaYZD'
        }, function(api_response) {
          
          global_response = api_response;
          
          document.getElementById("user_info").innerHTML += "<form><input id='search_bar' type='text'/><button onclick='search()'>search</button></form>";
          document.getElementById("recent_posts").innerHTML = "<strong>Recent Posts</strong><br/><br/>";
          
          clearModal();
          
          if (api_response["data"]){
            
            api_response["data"].forEach(function (post){
              console.log();
              var post_date = new Date(JSON.stringify(post["created_time"]).substring(0,17));
              var parent_post = "<div style='border: solid 2px grey; margin: 10px; border-radius: 15px'>" 
              parent_post += "<br/>" + post_date + JSON.stringify(post["message"]);
              // document.getElementById("recent_posts").innerHTML +=;
              
              if (post["comments"]){
                  var post_comments = ""; 
                  post_comments += "<div style='position: relative; padding: 40px; text-align: center'>";  
                  post["comments"]["data"].forEach(function(comment){
                    var comment = JSON.stringify(comment["message"]).replace("'","").replace(/[^\w\s.]/gi, '');
                    if (comment.length > 80) {
                      post_comments += "<button style='position: relative; width: 70%;'onclick='analyze(\"" + comment + "\")'>" + comment.substring(0, 80) + "...</button><br/>";
                    } else {
                       post_comments += "<button style='position: relative; width: 70%;'onclick='analyze(\"" + comment + "\")'>" + comment + "</button><br/>"; 
                    }
                  })
                   post_comments += "</div>";
                   parent_post +=  post_comments; 
              }
              
              parent_post += "</div><br/>";
              document.getElementById("recent_posts").innerHTML += parent_post;
            });
          } else {
            document.getElementById("recent_posts").innerHTML = "Something went wrong."
          }
          
        });
      } else {
        document.getElementById("head").innerHTML = "Please Log In";
      }
    })
  };

    function search(){
      document.getElementById("recent_posts").innerHTML = "<strong>Recent Posts</strong><br/><br/>";
      
        global_response["data"].forEach(function (post){
          if ( JSON.stringify(post["message"]).includes(document.getElementById("search_bar").value) ){    
          var parent_post = "<div style='border: solid 2px grey; margin: 10px; border-radius: 15px'>" 
              parent_post += "<br/>" + JSON.stringify(post["message"]);
              // document.getElementById("recent_posts").innerHTML +=;

            if (post["comments"]){
                var post_comments = ""; 
                post_comments += "<div style='position: relative; padding: 40px; text-align: center'>";  
                post["comments"]["data"].forEach(function(comment){
                  var comment = JSON.stringify(comment["message"]).replace("'","").replace(/[^\w\s.]/gi, '');
                  if (comment.length > 80) {
                    post_comments += "<button style='position: relative; width: 70%;'onclick='analyze(\"" + comment + "\")'>" + comment.substring(0, 80) + "...</button><br/>";
                  } else {
                     post_comments += "<button style='position: relative; width: 70%;'onclick='analyze(\"" + comment + "\")'>" + comment + "</button><br/>"; 
                  }
                })
                 post_comments += "</div>";
                 parent_post +=  post_comments; 
            }

            parent_post += "</div><br/>";
            document.getElementById("recent_posts").innerHTML += parent_post;
            }
          });
    }
    
  function clearModal(){
      document.getElementById("analysis_modal").innerHTML = "";
      document.getElementById("analysis_modal").style = "";
      document.getElementById("modal_background").style = "";
      document.getElementById("modal_container").style = "";
  }
  
  function analyze(message){
    var oReq = new XMLHttpRequest();
    oReq.open("POST", "https://text-sentiment.p.rapidapi.com/analyze");
    oReq.setRequestHeader("X-RapidAPI-Key", "GJjeiXWiy9msh8PhUc5GY5sarPaPp1hxySTjsnKmViFAeiK8jC");
    oReq.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    oReq.setRequestHeader("Access-Control-Allow-Origin", "*");
    oReq.send("text=" + message);
    
  
    
    document.getElementById("modal_container").style = "position: fixed; visibility: visible; top: 0px; left: 0px; width: 100%; height: 100%; text-align: center; top: 0px; left: 0px";
    
    document.getElementById("modal_background").style = "position: fixed; visibility: visible; top: 0px; left: 0px; width: 100%; height: 100%; background-color: grey; opacity: .7; text-align: center; top: 0px; left: 0px";
    
    document.getElementById("analysis_modal").style = "position: relative;  top: 25vh; width: 70vw; visibility: visible; border: solid 2px grey; background-color: white; display: inline-block; padding: 20px; border-radius: 15px;";
    
    document.getElementById("analysis_modal").innerHTML = "Please wait";
    oReq.onreadystatechange = function() {
    

      if (oReq.readyState == 4 && oReq.status == 200) {
        var analysis = "";
        analysis = "<strong>comment:</strong><br/><em>" + JSON.parse(oReq.responseText)["text"] + "</em><br/><br/><strong>analysis:</strong><br/><em>positive:</em> " + JSON.parse(oReq.responseText)["pos_percent"] + " | <em>negative:</em> " + JSON.parse(oReq.responseText)["neg_percent"] + " | <em>neutral:</em> " + JSON.parse(oReq.responseText)["mid_percent"];
        document.getElementById("analysis_modal").innerHTML = analysis;
      } else {
        document.getElementById("analysis_modal").innerHTML = "Something went wrong.<br/>" + oReq.responseText;
      }
        document.getElementById("analysis_modal").innerHTML += "<br/><br/><button onclick=\"clearModal()\">ok</button>";
      
       
    }
    // alert(message);
  }
    
    
  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "https://connect.facebook.net/en_US/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));
  </script>
  
  <body>
    
    <header>
      <h1 id="head">
        MC Senti
      </h1>
      
      <div id="user_info">
        <img id="user_photo" style="border-radius: 15px;"/>
        <span id="user_name" style="position: relative; bottom: 20px"></span><br/>
      </div>
      
    </header>

    <br/>
    <main>
      <div id="recent_posts" style="text-align: center">
      </div>

      <div id="modal_background" style="position: fixed; visibility: visible; top: 0px; left: 0px; width: 100%; height: 100%; background-color: grey; opacity: .7; text-align: center; top: 0px; left: 0px">
        
      </div>

      <div id="modal_container" style="position: fixed; visibility: visible; top: 0px; left: 0px; width: 100%; height: 100%; text-align: center; top: 0px; left: 0px">
        <div id="analysis_modal" style="position: relative;  top: 25vh; width: 70vw; visibility: visible; border: solid 2px grey; background-color: white; display: inline-block; padding: 20px; border-radius: 15px;">
          Please wait
        </div>
      </div>
    </main>

  </body>
</html>

<style>
  * {
    overflow-wrap: break-word;
    text-align: center;
  }
  
  #head, #user_info {
  }
</style>